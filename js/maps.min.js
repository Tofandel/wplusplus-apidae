/*
 * Copyright (c) Adrien Foulon - 2018. All rights reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
(function($){window.apidaeMaps=[];var WPlusPlusApidae=typeof window.WPlusPlusApidae!=="undefined"?window.WPlusPlusApidae:{maps:{}};var inited=false;window.initApidaeMaps=function(){if(!inited){inited=true;$(function(){$(".apidae-google-maps").apidaeMap()})}};$(function(){if(typeof google==="object"&&typeof google.maps==="object"){initApidaeMaps()}});$.fn.apidaeMap=function(){$(this).each(function(){var settings=$(this).data();settings=$.extend({type:"roadmap",center:null,animation:"drop",zoom:null,tilt:null,controls:false,disableUi:false,panorama:false,scrollwheel:true,draggable:true,mapStyle:null,animationDuration:2e3,clusterImagePath:WPlusPlusApidae.maps.clusterImagePath||false,useClusters:false,useSpiderfier:false},settings);var map,markers=[],bounds,last_marker=false,infoWindow=new google.maps.InfoWindow;var init=function(container){for(var i=0;i<markerNodes.length;i++){markerNodes[i].position=new google.maps.LatLng(parseFloat(markerNodes[i].lat),parseFloat(markerNodes[i].lng))}if(settings["center"]==null&&markerNodes.length>0){bounds=new google.maps.LatLngBounds;for(i=0;i<markerNodes.length;i++){bounds.extend(markerNodes[i].position)}var center=bounds.getCenter()}map=new google.maps.Map(container,{zoom:settings["zoom"]||12,center:center,mapTypeControl:settings["controls"],disableDefaultUI:settings["disableUi"],scrollwheel:settings["scrollwheel"],draggable:settings["draggable"],styles:settings["mapStyle"]?JSON.parse(decodeURIComponent(settings["mapStyle"])):null,mapTypeId:google.maps.MapTypeId[settings["type"].toUpperCase()]});window.apidaeMaps.push(map);if(settings["zoom"]==null){map.fitBounds(bounds)}if(settings["tilt"]!=null){map.setTilt(settings["tilt"])}if(markerNodes.length>0){render()}$(container).trigger("apidae-map-loaded",[map,markers])};var render=function(){var time=settings["animationDuration"]/markerNodes.length;for(var i=0;i<markerNodes.length;i++){if(settings["animation"]==""||settings["animation"]=="none"){addMarker(markerNodes[i])}else{addMarkerWithTimeout(markerNodes[i],i*time)}}if(settings["useClusters"]==true){if(settings["animation"]!="none"&&settings["animation"]!=""){setTimeout(function(){new MarkerClusterer(map,markers,{imagePath:settings["clusterImagePath"]})},settings["animationDuration"]+100)}else{new MarkerClusterer(map,markers,{imagePath:settings["clusterImagePath"]})}}};var showInfo=function(marker){if(last_marker!==false){closeInfo(last_marker)}last_marker=marker;infoWindow.setContent(marker.info);infoWindow.open(map,marker);marker.setAnimation(google.maps.Animation.BOUNCE)};var closeInfo=function(marker){marker.setAnimation(null);infoWindow.close()};if(settings["useSpiderfier"]){var oms=false,addMarker=function(pin){if(typeof pin.addMarker==="function"){pin.addMarker(pin,markers,map,showInfo);return}oms=oms?oms:new OverlappingMarkerSpiderfier(map,{markersWontMove:true,markersWontHide:true,basicFormatEvents:true});var html="<a href='"+pin.link+"'><b>"+pin.name+"</b></a> <br/>"+pin.addressLine1+"<br/>"+pin.addressLine2;var _marker=new google.maps.Marker({position:pin.position,icon:pin.icon,title:pin.name,info:html,pin:pin});oms.addMarker(_marker);markers.push(_marker);if(pin.auto_open){showInfo(_marker)}if(pin.info!=""){google.maps.event.addListener(_marker,"spider_click",function(){showInfo(_marker);$("#"+pin.id).addClass("pin-active")});$("#"+pin.id).on("hover",function(){showInfo(_marker)})}}}else{addMarker=function(pin){if(typeof pin.addMarker==="function"){pin.addMarker(pin,markers,map,showInfo);return}var html="<a href='"+pin.link+"'><b>"+pin.name+"</b></a> <br/>"+pin.addressLine1+"<br/>"+pin.addressLine2;var _marker=new google.maps.Marker({position:pin.position,map:map,icon:pin.icon,title:pin.name,info:html});markers.push(_marker);if(pin.auto_open){showInfo(_marker)}if(pin.info!=""){google.maps.event.addListener(_marker,"click",function(){showInfo(_marker);$("#"+pin.id).addClass("pin-active")});$("#"+pin.id).on("hover",function(){showInfo(_marker)})}}}var addMarkerWithTimeout=function(pin,timeout){setTimeout(function(){addMarker(pin)},timeout)};init(this)})}})(jQuery);